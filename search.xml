<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>通达OA前台任意用户登录漏洞复现</title>
      <link href="/2023/09/16/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/%E9%80%9A%E8%BE%BEOA%E5%89%8D%E5%8F%B0%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
      <url>/2023/09/16/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/%E9%80%9A%E8%BE%BEOA%E5%89%8D%E5%8F%B0%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>通达OA是一套使用比较广泛的办公系统。该漏洞因为使用uid作为身份标识，攻击者在远程且未经授权的情况下，通过利用此漏洞，可以直接绕过登录验证逻辑，伪装为系统管理员身份登录OA系统。通达OA官方于2020年4月17日发布安全更新。</p><h2 id="漏洞影响版本"><a href="#漏洞影响版本" class="headerlink" title="漏洞影响版本"></a>漏洞影响版本</h2><p>通达OA &lt; 11.5<br>通达OA 2017版本</p><h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>本次复现为2017版本，则重点分析该版本，但原理都是基本相同的，只不过文件路径不同而已。根据POC的代码分析如下，该漏洞涉及的文件包含以下四个：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ispirit/login_code.php</span><br><span class="line">/general/login_code_scan.php</span><br><span class="line">/ispirit/login_code_check.php</span><br><span class="line">/general/index.php</span><br></pre></td></tr></table></figure><p>通达OA源码使用zend5加密 ，分析源码需要先进行解密</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110222.png" alt="image-20230916180222601"></p><p>本事使用的解密工具是:SeayDzend，工具使用很简单</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110140.png" alt="image-20230916181002666"></p><h3 id="ispirit-login-code-php："><a href="#ispirit-login-code-php：" class="headerlink" title="&#x2F;ispirit&#x2F;login_code.php："></a><strong>&#x2F;ispirit&#x2F;login_code.php：</strong></h3><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110548.png" alt="image-20230916181726302"></p><p>该文件用来获取codeuid参数，如果不存在，则会自动生成一个codeuid，并且将其写入CODE_LOGIN_PC缓存中（通达OA使用了缓存系统Redis，同时也提供了对缓存的使用方法），但是在18行位置将这个参数显示出来，导致用户可以获取这个参数的值，从而可以绕过后面的验证。</p><h3 id="general-login-code-scan-php："><a href="#general-login-code-scan-php：" class="headerlink" title="&#x2F;general&#x2F;login_code_scan.php："></a><strong>&#x2F;general&#x2F;login_code_scan.php：</strong></h3><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170109895.png" alt="image-20230916182942854"></p><p>在这一文件中，用户可以控制输入的关键参数uid，在存在漏洞的通达OA版本中，后台数据库里uid对应的用户是admin管理员账户。并且将该数据存储在CODE_INFO_PC缓存中，因为我们在第一个文件中获取的codeuid存储在CODE_LOGIN_PC中，所以这里在复现时需要指明source变量为pc，这里的username则为admin，而type变量需要指明为confirm，原因在后面会进行解释。</p><h3 id="ispirit-login-code-check-php："><a href="#ispirit-login-code-check-php：" class="headerlink" title="&#x2F;ispirit&#x2F;login_code_check.php："></a><strong>&#x2F;ispirit&#x2F;login_code_check.php：</strong></h3><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110012.png" alt="image-20230916182413645"></p><p>这里使用之前存储的两个缓存中的内容，一个用来获取codeuid，一个用来获取通过post传入的uid等关键信息，这里红框就是为什么前一步需要将type设置为confirm。</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110249.png" alt="image-20230916182532863"></p><p>这里是最为关键的位置，代码获取用户可控的参数uid，并依次作为依据直接带入数据库进行查询</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110948.png" alt="image-20230916182612401"></p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110857.png" alt="image-20230916182757653"></p><p>随后将查询的信息直接写入session中，通过这一步，session中包含的就是管理员的身份信息。</p><p>以上就是该漏洞的原理，V11版本原理类似，可用对照POC中的步骤进行分析复现。</p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>通达OA-TDOA11.4_2 建议在虚拟机环境下安装</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">下载地址：https://cdndown.tongda2000.com/oa/2019/TDOA11.4.exe</span><br></pre></td></tr></table></figure><p>下载下来一路默认下一步就行！</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110446.png" alt="image-20230916184345376"></p><p>安装完成最后需要检测端口</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110742.png" alt="image-20230916184810146"></p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110101.png" alt="image-20230916184854995"></p><p>最后点击确定就行</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110356.png" alt="image-20230916185126003"></p><h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><h4 id="code1：手工利用"><a href="#code1：手工利用" class="headerlink" title="code1：手工利用"></a>code1：手工利用</h4><p>按照poc中的步骤，首先抓首页的包进行更改，访问&#x2F;ispirit&#x2F;login_code.php</p><p>通过返回包获取codeuid</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110472.png" alt="image-20230916190258275"></p><p>而后使用POST方式访问&#x2F;general&#x2F;login_code_scan.php提交payload，其中codeuid需要改为上一步中返回的值。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uid=1&amp;codeuid=&#123;3CD5FFC0-E64E-6E7E-123F-64A3578FF5A0&#125;&amp;type=confirm&amp;source=pc&amp;username=admin</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110996.png" alt="image-20230916190353017"></p><p>第三步使用GET方式访问&#x2F;ispirit&#x2F;login_code_check.php，带上参数codeuid，让后台进行代入查询，并返回携带管理员身份信息的凭证。</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110753.png" alt="image-20230916190427180"></p><p>经过这步后客户端已经拥有了管理员的身份信息，直接访问OA主页&#x2F;general&#x2F;index.php，放行该数据包，成功以管理员身份登录OA系统。</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110513.png" alt="image-20230916190511191"></p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110082.png" alt="image-20230916190536836"></p><h4 id="code2：POC利用"><a href="#code2：POC利用" class="headerlink" title="code2：POC利用"></a>code2：POC利用</h4><p><code>python3 .\POC.py -v 2017 -url http://192.168.142.129/</code></p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170111829.png" alt="image-20230916191545447"></p><p>访问主页<code>http://192.168.142.129/general/index.php</code></p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170111515.png" alt="image-20230916190714276"></p><p>修改cookie中PHPSESSID的值并刷新页面就会发现登录成功了</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170111828.png" alt="image-20230916191720131"></p><p>最后修改cookie也可以在bp里面修改</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170111144.png" alt="image-20230916191948049"></p><h2 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h2><p>更新最新版本</p><h2 id="复现环境所需安装包以及工具"><a href="#复现环境所需安装包以及工具" class="headerlink" title="复现环境所需安装包以及工具"></a>复现环境所需安装包以及工具</h2><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170111921.png" alt="image-20230916192513452"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">百度链接：https://pan.baidu.com/s/1BYpQZ8lqrHGJu1YohSxqQA?pwd=r8g3 </span><br><span class="line">提取码：r8g3 </span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 漏洞复现 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2023/09/16/hello-world/"/>
      <url>/2023/09/16/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
