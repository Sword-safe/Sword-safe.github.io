<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>通达OA前台任意用户登录漏洞复现</title>
      <link href="/2023/09/16/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/%E9%80%9A%E8%BE%BEOA%E5%89%8D%E5%8F%B0%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
      <url>/2023/09/16/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/%E9%80%9A%E8%BE%BEOA%E5%89%8D%E5%8F%B0%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>通达OA是一套使用比较广泛的办公系统。该漏洞因为使用uid作为身份标识，攻击者在远程且未经授权的情况下，通过利用此漏洞，可以直接绕过登录验证逻辑，伪装为系统管理员身份登录OA系统。通达OA官方于2020年4月17日发布安全更新。</p><h2 id="漏洞影响版本"><a href="#漏洞影响版本" class="headerlink" title="漏洞影响版本"></a>漏洞影响版本</h2><p>通达OA &lt; 11.5<br>通达OA 2017版本</p><h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>本次复现为2017版本，则重点分析该版本，但原理都是基本相同的，只不过文件路径不同而已。根据POC的代码分析如下，该漏洞涉及的文件包含以下四个：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ispirit/login_code.php</span><br><span class="line">/general/login_code_scan.php</span><br><span class="line">/ispirit/login_code_check.php</span><br><span class="line">/general/index.php</span><br></pre></td></tr></table></figure><p>通达OA源码使用zend5加密 ，分析源码需要先进行解密</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110222.png" alt="image-20230916180222601"></p><p>本事使用的解密工具是:SeayDzend，工具使用很简单</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110140.png" alt="image-20230916181002666"></p><h3 id="ispirit-login-code-php："><a href="#ispirit-login-code-php：" class="headerlink" title="&#x2F;ispirit&#x2F;login_code.php："></a><strong>&#x2F;ispirit&#x2F;login_code.php：</strong></h3><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110548.png" alt="image-20230916181726302"></p><p>该文件用来获取codeuid参数，如果不存在，则会自动生成一个codeuid，并且将其写入CODE_LOGIN_PC缓存中（通达OA使用了缓存系统Redis，同时也提供了对缓存的使用方法），但是在18行位置将这个参数显示出来，导致用户可以获取这个参数的值，从而可以绕过后面的验证。</p><h3 id="general-login-code-scan-php："><a href="#general-login-code-scan-php：" class="headerlink" title="&#x2F;general&#x2F;login_code_scan.php："></a><strong>&#x2F;general&#x2F;login_code_scan.php：</strong></h3><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170109895.png" alt="image-20230916182942854"></p><p>在这一文件中，用户可以控制输入的关键参数uid，在存在漏洞的通达OA版本中，后台数据库里uid对应的用户是admin管理员账户。并且将该数据存储在CODE_INFO_PC缓存中，因为我们在第一个文件中获取的codeuid存储在CODE_LOGIN_PC中，所以这里在复现时需要指明source变量为pc，这里的username则为admin，而type变量需要指明为confirm，原因在后面会进行解释。</p><h3 id="ispirit-login-code-check-php："><a href="#ispirit-login-code-check-php：" class="headerlink" title="&#x2F;ispirit&#x2F;login_code_check.php："></a><strong>&#x2F;ispirit&#x2F;login_code_check.php：</strong></h3><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110012.png" alt="image-20230916182413645"></p><p>这里使用之前存储的两个缓存中的内容，一个用来获取codeuid，一个用来获取通过post传入的uid等关键信息，这里红框就是为什么前一步需要将type设置为confirm。</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110249.png" alt="image-20230916182532863"></p><p>这里是最为关键的位置，代码获取用户可控的参数uid，并依次作为依据直接带入数据库进行查询</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110948.png" alt="image-20230916182612401"></p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110857.png" alt="image-20230916182757653"></p><p>随后将查询的信息直接写入session中，通过这一步，session中包含的就是管理员的身份信息。</p><p>以上就是该漏洞的原理，V11版本原理类似，可用对照POC中的步骤进行分析复现。</p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>通达OA-TDOA11.4_2 建议在虚拟机环境下安装</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">下载地址：https://cdndown.tongda2000.com/oa/2019/TDOA11.4.exe</span><br></pre></td></tr></table></figure><p>下载下来一路默认下一步就行！</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110446.png" alt="image-20230916184345376"></p><p>安装完成最后需要检测端口</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110742.png" alt="image-20230916184810146"></p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110101.png" alt="image-20230916184854995"></p><p>最后点击确定就行</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110356.png" alt="image-20230916185126003"></p><h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><h4 id="code1：手工利用"><a href="#code1：手工利用" class="headerlink" title="code1：手工利用"></a>code1：手工利用</h4><p>按照poc中的步骤，首先抓首页的包进行更改，访问&#x2F;ispirit&#x2F;login_code.php</p><p>通过返回包获取codeuid</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110472.png" alt="image-20230916190258275"></p><p>而后使用POST方式访问&#x2F;general&#x2F;login_code_scan.php提交payload，其中codeuid需要改为上一步中返回的值。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uid=1&amp;codeuid=&#123;3CD5FFC0-E64E-6E7E-123F-64A3578FF5A0&#125;&amp;type=confirm&amp;source=pc&amp;username=admin</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110996.png" alt="image-20230916190353017"></p><p>第三步使用GET方式访问&#x2F;ispirit&#x2F;login_code_check.php，带上参数codeuid，让后台进行代入查询，并返回携带管理员身份信息的凭证。</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110753.png" alt="image-20230916190427180"></p><p>经过这步后客户端已经拥有了管理员的身份信息，直接访问OA主页&#x2F;general&#x2F;index.php，放行该数据包，成功以管理员身份登录OA系统。</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110513.png" alt="image-20230916190511191"></p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170110082.png" alt="image-20230916190536836"></p><h4 id="code2：POC利用"><a href="#code2：POC利用" class="headerlink" title="code2：POC利用"></a>code2：POC利用</h4><p><code>python3 .\POC.py -v 2017 -url http://192.168.142.129/</code></p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170111829.png" alt="image-20230916191545447"></p><p>访问主页<code>http://192.168.142.129/general/index.php</code></p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170111515.png" alt="image-20230916190714276"></p><p>修改cookie中PHPSESSID的值并刷新页面就会发现登录成功了</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170111828.png" alt="image-20230916191720131"></p><p>最后修改cookie也可以在bp里面修改</p><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170111144.png" alt="image-20230916191948049"></p><h2 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h2><p>更新最新版本</p><h2 id="复现环境所需安装包以及工具"><a href="#复现环境所需安装包以及工具" class="headerlink" title="复现环境所需安装包以及工具"></a>复现环境所需安装包以及工具</h2><p><img src="https://gitee.com/jianhao_com/picture/raw/master/202309170111921.png" alt="image-20230916192513452"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">百度链接：https://pan.baidu.com/s/1BYpQZ8lqrHGJu1YohSxqQA?pwd=r8g3 </span><br><span class="line">提取码：r8g3 </span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 漏洞复现 </category>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 123 </tag>
            
            <tag> 456 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>博客自述</title>
      <link href="/2022/12/27/hello-world/"/>
      <url>/2022/12/27/hello-world/</url>
      
        <content type="html"><![CDATA[<p>由于博主很穷，兜比脸干净，所以主打的就是一个白嫖</p><p>博客是用GitHub+hexo搭建，图传用的是PicGo+Github+Gitee</p><p>hexo主题用的是安知鱼</p><p>hexo地址：<a href="https://hexo.io/zh-cn/">https://hexo.io/zh-cn/</a></p><p>安知鱼下载地址：<a href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu">anzhiyu-c&#x2F;hexo-theme-anzhiyu: 这是一个简洁美丽的hexo主题。 (github.com)</a></p><p>安知鱼使用文档：<a href="https://docs.anheyu.com/">安知鱼主题官方文档 | 一个简洁、美丽的静态hexo主题 (anheyu.com)</a></p><p><strong>由于各种白嫖，所以访问速度很慢，图片经常出现加载不出来的情况，各位大佬见谅，如遇到图片没有加载请多刷新几次页面！</strong></p>]]></content>
      
      
      <categories>
          
          <category> 博客自述 </category>
          
      </categories>
      
      
    </entry>
    
    
  
  
</search>
